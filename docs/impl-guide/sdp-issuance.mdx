---
sidebar_position: 2
---

# SDP 生成・署名

このページでは、署名付き Document Profile (SDP) を生成する手順を説明します。この手順では profile-registry CLI などのツールに頼らずに一から SDP を生成します。

手順の解説の際に、CIP が実装した Wordpress 連携のソースコードの抜粋を適宜引用します。 Wordpress 連携のソースコードは[こちら](https://github.com/originator-profile/profile-share/tree/main/packages/wordpress) にあり、実証実験参加者の方は[事務局にご連絡いただいた GitHub アカウント](/media-study-202307/howto.md#github-アカウント) を利用して自由に見ることができます。ソースコードの引用は実装のイメージを理解してもらうためであり、 WordPress や PHP の使用を推奨するためではありません。

SDP 生成の手順は次のようになっています。

1. 記事の情報を収集する
2. 署名する記事コンテンツを選択する
3. 記事コンテンツに署名をする
4. それらの情報をまとめて DP を作る
5. DP に署名をして SDP を作る

DP は URL ごとに必要なため、公開する記事が複数ページに分かれている場合はページ数分作ってください。

## 記事の情報を収集する

記事に関する情報を収集します。記事を閲覧するユーザーは、 Originator Profile 拡張機能を使ってこれらの情報を確認することができます。

次の2つの JSON はそれぞれ SDP のヘッダー部とペイロード部です。

SDP ヘッダー部:

```json
{
  "alg": "ES256",
  "kid": "jJYs5_ILgUc8180L-pBPxBpgA3QC7eZu9wKOkh9mYPU",
  "typ": "JWT"
}
```

SDP ペイロード部:

```json
{
  "https://originator-profile.org/dp": {
    "item": [
      {
        "type": "website",
        "url": "http://localhost:8080",
        "title": "OP 確認くん",
        "image": "https://example.com/image.png",
        "description": "このウェブページの説明です。",
        "https://schema.org/author": "山田太郎",
        "category": [],
        "https://schema.org/editor": "山田花子",
        "https://schema.org/datePublished": "2023-07-04T19:14:00Z",
        "https://schema.org/dateModified": "2023-07-04T19:14:00Z"
      },
      {
        "type": "visibleText",
        "url": "http://localhost:8080",
        "location": "h1",
        "proof": {
          "jws": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImpKWXM1X0lMZ1VjODE4MEwtcEJQeEJwZ0EzUUM3ZVp1OXdLT2toOW1ZUFUiLCJiNjQiOmZhbHNlLCJjcml0IjpbImI2NCJdfQ..iW5cLsuUaABodKMynyCBH95j7WWemNlJ5CCi4iVwH_SlkN6KVV9jB4GJxN2pwG7N8IKsXrZ42TBSiP4LLn-83g"
        }
      }
    ]
  },
  "iss": "localhost",
  "sub": "ff9d78e0-d81a-4e39-b7a0-27e15405edc7",
  "iat": 1688623395,
  "exp": 1720245795
}
```

各クレームの詳細については[仕様](/spec/)をご確認ください。

## 署名をする記事コンテンツを選択する

次に、署名をする記事コンテンツを選択してください。

上記の例の中の item プロパティの2番目の要素には、 `jws` が含まれていました。

```json
{
  "type": "visibleText",
  "url": "http://localhost:8080",
  "location": "h1",
  "proof": {
    "jws": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImpKWXM1X0lMZ1VjODE4MEwtcEJQeEJwZ0EzUUM3ZVp1OXdLT2toOW1ZUFUiLCJiNjQiOmZhbHNlLCJjcml0IjpbImI2NCJdfQ..iW5cLsuUaABodKMynyCBH95j7WWemNlJ5CCi4iVwH_SlkN6KVV9jB4GJxN2pwG7N8IKsXrZ42TBSiP4LLn-83g"
  }
}
```

この `jws` は記事コンテンツに対する署名であり、記事担当者が保持するプライベート鍵を使って生成する必要があります。記事コンテンツ中のどの部分に署名するかは、署名をする際に選ぶことができます。これは CSS セレクターで指定する必要があります。 `location` プロパティがその値です。
選択したコンテンツは、記事ページ上で拡張機能を起動した際に、ハイライトされ、署名の検証が通った場合には、ツールチップに署名対象文字列が表示されます。下の画像の場合、署名対象文字列は「これはサブコンテンツです。」になります。

import Image from "./assets/jws-verification-success-tooltip.png";

<img src={Image} width={500} />

署名対象の記事コンテンツによって3種類のデータ構造が定義されています。これは上記の JSON の中の `type` プロパティで指定します。自身のニーズに合わせて選んでください。

- [visibleText 型](/spec.md#visibletext-型)
- [text 型](/spec.md#text-型)
- [html 型](/spec.md#html-型)

## 記事コンテンツに署名をする

次に選んだコンテンツに署名をします。署名に使うプライベート鍵としてはレジストリに登録した公開鍵に対応するものを使ってください。

この署名は [RFC 7797](https://www.rfc-editor.org/rfc/rfc7797) の Unencoded Payload Option を付与した JWS になっており、 JWS ヘッダー部の中の `b64` がそのオプションです。`crit` パラメータも必要となります。
署名したいデータを base64 エンコードせずにそのまま使えるという特徴があります。また、上記 RFC の [Section 5.1](https://www.rfc-editor.org/rfc/rfc7797#section-5.1) にのっとり、ペイロード部は JWS から省略してください (Detached Payload) 。

JWS ヘッダー部:

```json
{
  "alg": "ES256",
  "kid": "jJYs5_ILgUc8180L-pBPxBpgA3QC7eZu9wKOkh9mYPU",
  "b64": false,
  "crit": ["b64"]
}
```

CIP 実装の Wordpress プラグインでは、このように[実装されています](https://github.com/originator-profile/profile-share/blob/v0.0.9/packages/wordpress/includes/issue.php#L201-L229)。

```php
/**
 * 対象のテキストへの署名 (RFC 7797)
 *
 * @param string $body 対象のテキスト
 * @param string $pkcs8 PEM base64 でエンコードされた PKCS #8 プライベート鍵またはそのファイルパス
 * @return string|false 成功した場合はDetached Compact JWS、失敗した場合はfalse
 */
function sign_body( string $body, string $pkcs8 ): string|false {
	// $pkey はレジストリに登録した公開鍵に対応するプライベート鍵です
	$pkey = \openssl_pkey_get_private( $pkcs8 );
	$jwk  = get_jwk( $pkey );

	if ( ! $jwk ) {
		return false;
	}

	// JWS のヘッダーを生成しています。
	$header = array(
		'alg'  => $jwk['alg'],
		'kid'  => $jwk['kid'],
		'b64'  => false,
		'crit' => array( 'b64' ),
	);

	$protected = base64_urlsafe_encode( \json_encode( $header ) );
	/* b64 を false に設定したため、 $body は base64 エンコードをする必要がありません。
	   つまり、 $body = "あいうえお", $protected = "eyJ...fQ" の場合、 $data は次のようになります。

		 eyJ...fQ.あいうえお

	   この文字列に対する署名が $signature です。
	*/
	$data      = "{$protected}.{$body}";
	$signature = ( new Sha256() )->sign( $data, InMemory::plainText( $pkcs8 ) );
	/* $body は、jws には含めません。これは、記事ページ上で jws を検証するときに、拡張機能が記事から取得します。
		 参考: RFC 7797 Section 5.1 Unencoded Detached Payload https://www.rfc-editor.org/rfc/rfc7797#section-5.1
		      RFC 7515 Appendix F. Detached Content https://www.rfc-editor.org/rfc/rfc7515.html#appendix-F
	*/
	$jws       = $protected . '..' . base64_urlsafe_encode( $signature );

	return $jws;
}
```

## 情報をまとめて DP を作る

ここまでの手順で、 DP に必要な情報は全て用意できました。これを DP の仕様に従って適切なクレーム・プロパティの中に入れてください。この手順の最初に載せた DP の例に従ってください。より詳しい情報については[仕様](/spec/)を参考にしてください。

仕様に準拠していない場合には、情報を入れたにも関わらず、検証に失敗したり、ユーザーに提示されなくなる可能性があります。

## DP に署名をして SDP を作る

最後に DP に署名をして SDP を作ってください。一般的な JWT の仕様である [RFC 7519](https://www.rfc-editor.org/rfc/rfc7519) に従ってください。署名に使うプライベート鍵としてはレジストリに登録した公開鍵に対応するものを使ってください。

CIP の Wordpress 連携では [lcobucci/jwt](https://github.com/lcobucci/jwt) を使用し、次のように[実装されています](https://github.com/originator-profile/profile-share/blob/v0.0.9/packages/wordpress/includes/class-dp.php#L96-L115)。

```php
		$builder = (
				new Builder( new JoseEncoder(), ChainedFormatter::withUnixTimestampDates() )
			)
				->withHeader( 'alg', $jwk['alg'] )
				->withHeader( 'kid', $jwk['kid'] )
				->issuedBy( $dp['issuer'] )
				->relatedTo( $dp['subject'] )
				->issuedAt(
					( new \DateTimeImmutable() )
					->setTimestamp( \strtotime( $dp['issuedAt'] ) )
				)
				->expiresAt(
					( new \DateTimeImmutable() )
					->setTimestamp( \strtotime( $dp['expiredAt'] ) )
				)
				->withClaim( 'https://originator-profile.org/dp', array( 'item' => $dp['item'] ) );

		$jwt = $builder->getToken( new Sha256(), InMemory::plainText( $pkcs8 ) );

		return $jwt->toString();
```

これにより、次のような JWT が生成されます。

```
eyJhbGciOiJFUzI1NiIsImtpZCI6ImpKWXM1X0lMZ1VjODE4MEwtcEJQeEJwZ0EzUUM3ZVp1OXdLT2toOW1ZUFUiLCJ0eXAiOiJKV1QifQ.eyJodHRwczovL29yaWdpbmF0b3ItcHJvZmlsZS5vcmcvZHAiOnsiaXRlbSI6W3sidHlwZSI6IndlYnNpdGUiLCJ1cmwiOiJodHRwOi8vbG9jYWxob3N0OjgwODAiLCJ0aXRsZSI6Ik9QIOeiuuiqjeOBj-OCkyIsImltYWdlIjoiaHR0cHM6Ly9leGFtcGxlLmNvbS9pbWFnZS5wbmciLCJkZXNjcmlwdGlvbiI6IuOBk-OBruOCpuOCp-ODluODmuODvOOCuOOBruiqrOaYjuOBp-OBmeOAgiIsImh0dHBzOi8vc2NoZW1hLm9yZy9hdXRob3IiOiLlsbHnlLDlpKrpg44iLCJjYXRlZ29yeSI6W10sImh0dHBzOi8vc2NoZW1hLm9yZy9lZGl0b3IiOiLlsbHnlLDoirHlrZAiLCJodHRwczovL3NjaGVtYS5vcmcvZGF0ZVB1Ymxpc2hlZCI6IjIwMjMtMDctMDRUMTk6MTQ6MDBaIiwiaHR0cHM6Ly9zY2hlbWEub3JnL2RhdGVNb2RpZmllZCI6IjIwMjMtMDctMDRUMTk6MTQ6MDBaIn0seyJ0eXBlIjoidmlzaWJsZVRleHQiLCJ1cmwiOiJodHRwOi8vbG9jYWxob3N0OjgwODAiLCJsb2NhdGlvbiI6ImgxIiwicHJvb2YiOnsiandzIjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJbXRwWkNJNkltcEtXWE0xWDBsTVoxVmpPREU0TUV3dGNFSlFlRUp3WjBFelVVTTNaVnAxT1hkTFQydG9PVzFaVUZVaUxDSmlOalFpT21aaGJITmxMQ0pqY21sMElqcGJJbUkyTkNKZGZRLi5pVzVjTHN1VWFBQm9kS015bnlDQkg5NWo3V1dlbU5sSjVDQ2k0aVZ3SF9TbGtONktWVjlqQjRHSnhOMnB3RzdOOElLc1hyWjQyVEJTaVA0TExuLTgzZyJ9fV19LCJpc3MiOiJsb2NhbGhvc3QiLCJzdWIiOiJmZjlkNzhlMC1kODFhLTRlMzktYjdhMC0yN2UxNTQwNWVkYzciLCJpYXQiOjE2ODg2MjMzOTUsImV4cCI6MTcyMDI0NTc5NX0.31h0GW7DJK-UOzAVFoG_ukgGjAkg0da62ujeyj4bdr2cFgeQqt-yreS9MLKfw-Kcyfn5Lryqd7uvFP6xAZSGmA
```

以上で SDP の生成が終了しました。この処理は、記事を新規作成したり、更新したりするタイミングで行われるのが望ましいです。CMS連携を実装する際にはそのように実装してください。

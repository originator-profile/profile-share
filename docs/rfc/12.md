# External Resource Target - Editor's Draft

## 概要

本文書は、画像や動画などの外部リソースファイルの完全性を保証するための形式について説明します。

:::note

この target について実証実験の参加企業の方々からフィードバックをいただく予定です。

参考: [画像加工を伴う CDN 利用時の検証可能化方法の検討 · Issue #1426 · originator-profile/profile](https://github.com/originator-profile/profile/issues/1426)

:::

## 範囲

- 静的なバイナリファイルを扱います。
- JavaScript 等によって生成される動的なリソースは本文書の範囲外です。
- Adaptive Bitrate Streaming で配信される動画は扱いません。単一の動画ファイルとして配信される動画のみ扱います。
- background-image CSS プロパティや content CSS プロパティといった CSS で取得表示されるリソースは本文書の範囲外です。
- [コンテンツネゴシエーション](https://developer.mozilla.org/docs/Web/HTTP/Content_negotiation)による動的なリソースは本文書の範囲外です。

## 用語

本文書に説明のない用語については、用語 RFC 文書を参照してください。

- Content Assertion (CA)

## External Resource Target の形式

JSON オブジェクトでなければなりません。
External Resource Target の具体例を次に示します。

```json
{
  "type": "externalResource",
  "integrity": "sha-256..."
}
```

以下のプロパティが定義されます:

- `type`: REQUIRED. 必ず `externalResource` でなければなりません (MUST)。
- `integrity`: REQUIRED. [Subresource Integrity (SRI) セクション 3.1](https://www.w3.org/TR/SRI/#framework) の Integrity metadata でなければなりません (MUST)。具体例: `sha256-4HLmAAYVRClrk+eCIrI1Rlf5/IKK0+wGoYjRs9vzl7U=`

:::note

CA に含まれるメタデータとは異なる、メディアの種類 (PDF、音声、画像、動画など) に応じてリソースに埋め込まれるメタデータの取り扱いは本仕様の範囲外です。

:::

:::note

SRI の署名アルゴリズムの対応は[議論](https://github.com/w3c/webappsec/issues/449)されており、今後の動向によっては本仕様も見直す可能性があります。

:::

## 提示方法

`integrity` プロパティと同じ値を HTML 要素の `integrity` 属性に指定します。

#### 例

source 要素と img 要素に対する External Resource Target を提示する場合の具体例を次に示します。

```html
<picture>
  <source srcset="image.jpg" integrity="sha-256..." />
  <img src="https://cdn.example.com/image.jpg" integrity="sha-256..." />
</picture>
```

video 要素に対する External Resource Target を提示する場合の具体例を次に示します。この場合、src 属性に指定された外部リソースが検証され、poster 属性に指定された外部リソースは検証されません。

```html
<video
  src="https://cdn.example.com/video.mp4"
  integrity="sha-256..."
  poster="https://cdn.example.com/poster.jpg"
></video>
```

:::note

今後 SRI による検証の範囲を拡張するような HTML 属性を定義する可能性があります。たとえば poster 属性の完全性検証をおこなうための poster-integrity 属性などです。

:::

## 検証プロセス

1. `integrity` プロパティと同じ値を `integrity` HTML 属性に含む要素を検索します。
2. 要素から外部リソースを取得します。
3. その結果と integrity プロパティの Integrity metadata を [SRI セクション 3.3.5](https://www.w3.org/TR/SRI/#does-response-match-metadatalist) に規定されている方法で検証します

:::note

Originator Profile 技術研究組合の開発するアプリケーションでは、実装しやすさを念頭に以下の制約を設けます。

- `integrity` 属性に対して単一の Integrity metadata を取り扱います。
- `src` 属性から外部リソースを取得します。

:::

## 要素位置特定方法

:::note

CA と DOM の対応関係が自明ではないため、上記検証プロセスにもとづく UI の実装は複雑であり、CIP が実装するアプリケーションやブラウザでの実装の容易化や効率化のために仕様を変更する可能性があります。

:::

`integrity` プロパティと同じ値を `integrity` HTML 属性に含む要素を検索します。

## 参考文献

- [W3C Subresource Integrity](https://www.w3.org/TR/SRI/)
- [webappsec-subresource-integrity/signature-based-restrictions-explainer.markdown at main · w3c/webappsec-subresource-integrity](https://github.com/w3c/webappsec-subresource-integrity/blob/main/signature-based-restrictions-explainer.markdown)
- [Content Security Policy Level 3](https://w3c.github.io/webappsec-csp/)
- [Apply subresource integrity to `<img>` tags · Issue #113 · w3c/webappsec-subresource-integrity](https://github.com/w3c/webappsec-subresource-integrity/issues/113)
- [integrity for downloads · Issue #68 · w3c/webappsec-subresource-integrity](https://github.com/w3c/webappsec-subresource-integrity/issues/68)
- [SRI: Integrity enforcement on downloads · Issue #497 · w3c/webappsec](https://github.com/w3c/webappsec/issues/497)
- [\[SRI\] Support signatures/asymm key · Issue #449 · w3c/webappsec](https://github.com/w3c/webappsec/issues/449)
- [Consideration: Allow integrity-check based on signature instead of actual hash · Issue #85 · w3c/webappsec-subresource-integrity](https://github.com/w3c/webappsec-subresource-integrity/issues/85)

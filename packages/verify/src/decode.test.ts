import { test, expect } from "vitest";
import { TokenDecoder } from "./decode";
import { ProfileClaimsValidationFailed } from "./errors";

test("無効な形式のJWTのときデコードに失敗", async () => {
  const invalidToken = "invalid.jwt";
  const decoder = TokenDecoder(null);
  const decoded = decoder(invalidToken);
  expect(decoded).instanceOf(ProfileClaimsValidationFailed);
});

test("successfully decode a valid SD-JWT OP", async () => {
  const opToken =
    "eyJhbGciOiJFUzI1NiIsImtpZCI6IjIwX1hDazM2dFFrUlpsQnhEckhzMVhldHBUZUZYdDRfVlRSbHlEa0YyQWsiLCJ0eXAiOiJ2YytzZC1qd3QifQ.eyJ2Y3QiOiJodHRwczovL29yaWdpbmF0b3ItcHJvZmlsZS5vcmcvb3JpZ2luYXRvcl9wcm9maWxlIiwidmN0I2ludGVncml0eSI6InNoYTI1NiIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC8iLCJpc3MjaW50ZWdyaXR5Ijoic2hhMjU2Iiwic3ViIjoibG9jYWxob3N0IiwibG9jYWxlIjoiamEtSlAiLCJpc3N1ZXIiOnsiY291bnRyeSI6IkpQIiwiZG9tYWluX25hbWUiOiJsb2NhbGhvc3QiLCJ1cmwiOiJodHRwczovL29yaWdpbmF0b3ItcHJvZmlsZS5vcmcvIiwibmFtZSI6Ik9yaWdpbmF0b3IgUHJvZmlsZSDmioDooZPnoJTnqbbntYTlkIggKOmWi-eZuueUqCkiLCJsb2dvIjoiaHR0cHM6Ly9vcmlnaW5hdG9yLXByb2ZpbGUub3JnL2ltYWdlL2ljb24uc3ZnIiwiY29ycG9yYXRlX251bWJlciI6IjgwMTAwMDUwMzU5MzMiLCJwb3N0YWxfY29kZSI6IjEwMC04MDU1IiwicmVnaW9uIjoi5p2x5Lqs6YO9IiwibG9jYWxpdHkiOiLljYPku6PnlLDljLoiLCJzdHJlZXRfYWRkcmVzcyI6IuWkp-aJi-eUujEtNy0xIiwiY29udGFjdF90aXRsZSI6IuOBiuWVj-OBhOWQiOOCj-OBmyIsImNvbnRhY3RfdXJsIjoiaHR0cHM6Ly9vcmlnaW5hdG9yLXByb2ZpbGUub3JnL2phLUpQL2lucXVpcnkvIiwicHJpdmFjeV9wb2xpY3lfdGl0bGUiOiLjg5fjg6njgqTjg5Djgrfjg7zjg53jg6rjgrfjg7wiLCJwcml2YWN5X3BvbGljeV91cmwiOiJodHRwczovL29yaWdpbmF0b3ItcHJvZmlsZS5vcmcvamEtSlAvcHJpdmFjeS8ifSwiaG9sZGVyIjp7ImNvdW50cnkiOiJKUCIsImRvbWFpbl9uYW1lIjoibG9jYWxob3N0IiwidXJsIjoiaHR0cHM6Ly9vcmlnaW5hdG9yLXByb2ZpbGUub3JnLyIsIm5hbWUiOiJPcmlnaW5hdG9yIFByb2ZpbGUg5oqA6KGT56CU56m257WE5ZCIICjplovnmbrnlKgpIiwibG9nbyI6Imh0dHBzOi8vb3JpZ2luYXRvci1wcm9maWxlLm9yZy9pbWFnZS9pY29uLnN2ZyIsImNvcnBvcmF0ZV9udW1iZXIiOiI4MDEwMDA1MDM1OTMzIiwicG9zdGFsX2NvZGUiOiIxMDAtODA1NSIsInJlZ2lvbiI6IuadseS6rOmDvSIsImxvY2FsaXR5Ijoi5Y2D5Luj55Sw5Yy6Iiwic3RyZWV0X2FkZHJlc3MiOiLlpKfmiYvnlLoxLTctMSIsImNvbnRhY3RfdGl0bGUiOiLjgYrllY_jgYTlkIjjgo_jgZsiLCJjb250YWN0X3VybCI6Imh0dHBzOi8vb3JpZ2luYXRvci1wcm9maWxlLm9yZy9qYS1KUC9pbnF1aXJ5LyIsInByaXZhY3lfcG9saWN5X3RpdGxlIjoi44OX44Op44Kk44OQ44K344O844Od44Oq44K344O8IiwicHJpdmFjeV9wb2xpY3lfdXJsIjoiaHR0cHM6Ly9vcmlnaW5hdG9yLXByb2ZpbGUub3JnL2phLUpQL3ByaXZhY3kvIn0sImp3a3MiOnsia2V5cyI6W3sieCI6InlwQWxVam81TzVzb1VOSGszbWxSeWZ3NnVqeHFqZkRfSE1RdDdYSC1yU2ciLCJ5IjoiMWNtdjlsbVp2TDBYQUVSTnh2clQya1prQzRVd3U1aTFPcjFPLTRpeEp1RSIsImNydiI6IlAtMjU2Iiwia2lkIjoiakpZczVfSUxnVWM4MTgwTC1wQlB4QnBnQTNRQzdlWnU5d0tPa2g5bVlQVSIsImt0eSI6IkVDIn1dfSwiaWF0IjoxNzIwNTkzODU3LCJleHAiOjE3NTIxMjk4NTd9.pnq7jXx8xAf7FvP8fiHtXX7dkmd8AFGJy9qeo9eNjKiwPEOQMyTPkOeeDuydwfBTZbwzBGIg_oG96s1E0yIO-Q~";
  const decoder = TokenDecoder(null);
  const decoded = decoder(opToken);
  expect(decoded).toMatchObject({});
});

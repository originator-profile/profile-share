datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../../../docs/registry/assets/erd.md"
}

/// OP 文書
model ops {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 認証機構
  certifier   accounts      @relation(fields: [certifierId], references: [id])
  certifierId String        @db.Uuid
  /// 発行日
  issuedAt    DateTime
  /// 有効期限
  expiredAt   DateTime
  /// JWT
  jwt         String        @unique
  /// 公開
  publication publications?
}

/// DP 文書
model dps {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 発行者
  issuer    accounts @relation(fields: [issuerId], references: [id])
  issuerId  String   @db.Uuid
  /// 発行日
  issuedAt  DateTime
  /// 有効期限
  expiredAt DateTime
  /// JWT
  jwt       String   @unique
}

/// 会員
model accounts {
  id                       String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// ウェブサイトのURL*
  url                      String                      @unique
  /// 会員種別
  role                     roles                       @relation(fields: [roleValue], references: [value])
  roleValue                String                      @default("group")
  /// 法人名*
  name                     String
  /// 説明 (ウェブメディアそれを運用する法人、認定機関、業界団体等であることの記述)
  description              String?
  /// 事業種目
  businessCategories       accountBusinessCategories[]
  /// メールアドレス
  email                    String?
  /// 電話番号
  phoneNumber              String?
  /// 郵便番号*
  postalCode               String
  /// 国*
  addressCountry           String
  /// 都道府県*
  addressRegion            String
  /// 市区町村*
  addressLocality          String
  /// 番地・ビル名*
  streetAddress            String
  /// 連絡先表示名
  contactTitle             String?
  /// 連絡先URL
  contactUrl               String?
  /// プライバシーポリシー表示名
  privacyPolicyTitle       String?
  /// プライバシーポリシーURL
  privacyPolicyUrl         String?
  /// 編集ガイドライン表示名
  publishingPrincipleTitle String?
  /// 編集ガイドラインURL
  publishingPrincipleUrl   String?
  /// ロゴ画像
  logos                    logos[]
  /// OP文書発行履歴
  issuedOps                ops[]
  /// DP文書発行履歴
  issuedDps                dps[]
  /// OP文書公開履歴
  publications             publications[]
  /// 公開鍵
  keys                     keys[]
  /// ウェブページ
  websites                 websites[]
}

/// 会員種別
model roles {
  /// "group": 組織、"certifier": 認証機構
  value    String     @id
  /// 会員
  accounts accounts[]
}

/// 事業種目
model businessCategories {
  /// 事業種目
  value    String                      @id
  /// 会員
  accounts accountBusinessCategories[]
}

/// 会員・事業種目リレーション
model accountBusinessCategories {
  /// 会員
  account               accounts           @relation(fields: [accountId], references: [id])
  accountId             String             @db.Uuid
  /// 事業種目
  businessCategory      businessCategories @relation(fields: [businessCategoryValue], references: [value])
  businessCategoryValue String

  @@id([accountId, businessCategoryValue])
}

/// ロゴ画像
model logos {
  /// ロゴ画像 URL
  url       String   @id
  /// 主なロゴ画像か否か (true: 主なロゴ画像、それ以外: ロゴ画像の候補)
  isMain    Boolean  @default(false)
  /// 会員
  account   accounts @relation(fields: [accountId], references: [id])
  accountId String   @db.Uuid
}

/// 公開
model publications {
  /// OP 文書
  op          ops      @relation(fields: [opId], references: [id])
  opId        String   @id @db.Uuid
  /// 会員
  account     accounts @relation(fields: [accountId], references: [id])
  accountId   String   @db.Uuid
  /// 公開日
  publishedAt DateTime @default(now())
}

/// 公開鍵
model keys {
  id        Int      @id @default(autoincrement())
  /// 会員
  account   accounts @relation(fields: [accountId], references: [id])
  accountId String   @db.Uuid
  /// JWK
  jwk       Json
}

/// ウェブページ
model websites {
  id              Int         @id @default(autoincrement())
  /// 会員
  account         accounts    @relation(fields: [accountId], references: [id])
  accountId       String      @db.Uuid
  /// URL
  url             String
  /// タイトル
  title           String?
  /// 画像URL
  image           String?
  /// 説明
  description     String?
  /// https://schema.org/author
  author          String?
  /// https://schema.org/category (例えば IAB 2.0 モデル)
  category        String?
  /// https://schema.org/editor
  editor          String?
  /// 対象の要素の場所 (CSS セレクター)
  location        String?
  /// 対象のテキストの形式
  bodyFormat      bodyFormats @relation(fields: [bodyFormatValue], references: [value])
  bodyFormatValue String
  /// 対象のテキストへの署名 (Detached JSON Web Signature)
  proofJws        String
}

/// 本文の形式
model bodyFormats {
  /// "visibleText" "text" "html"
  value    String     @id
  /// ウェブページ
  websites websites[]
}

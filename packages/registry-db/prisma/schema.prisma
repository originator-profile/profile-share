datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../../../docs/registry/assets/erd.md"
}

/// Signed Originator Profile
model ops {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 認証機関
  certifier   accounts      @relation(fields: [certifierId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  certifierId String        @db.Uuid
  /// 発行日
  issuedAt    DateTime
  /// 期限切れ日時
  expiredAt   DateTime
  /// JWT
  jwt         String
  /// 公開
  publication publications?
  /// 申請
  request     requests?
  /// 申請ログ
  requestLog  requestLogs?
}

/// Signed Document Profile
model dps {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 発行者
  issuer    accounts  @relation(fields: [issuerId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  issuerId  String    @db.Uuid
  /// 発行日
  issuedAt  DateTime
  /// 期限切れ日時
  expiredAt DateTime
  /// JWT
  jwt       String
  /// ウェブページ
  website   websites? @relation(fields: [websiteId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  websiteId String?   @db.Uuid
}

/// 会員
model accounts {
  /// 会員 ID (UUID v5 for domain names)
  id                       String                      @id @default(dbgenerated()) @db.Uuid
  /// ドメイン名
  domainName               String                      @unique
  /// ウェブサイトのURL
  url                      String?
  /// 会員種別
  role                     roles                       @relation(fields: [roleValue], references: [value])
  roleValue                String                      @default("group")
  /// 法人名*
  name                     String
  /// 法人番号
  corporateNumber          String?
  /// 説明 (ウェブメディアそれを運用する法人、認定機関、業界団体等であることの記述)
  description              String?
  /// 事業種目
  businessCategories       accountBusinessCategories[]
  /// メールアドレス
  email                    String?
  /// 電話番号
  phoneNumber              String?
  /// 郵便番号*
  postalCode               String
  /// 国*
  addressCountry           String
  /// 都道府県*
  addressRegion            String
  /// 市区町村*
  addressLocality          String
  /// 番地・ビル名*
  streetAddress            String
  /// 連絡先表示名
  contactTitle             String?
  /// 連絡先URL
  contactUrl               String?
  /// プライバシーポリシー表示名
  privacyPolicyTitle       String?
  /// プライバシーポリシーURL
  privacyPolicyUrl         String?
  /// 編集ガイドライン表示名
  publishingPrincipleTitle String?
  /// 編集ガイドラインURL
  publishingPrincipleUrl   String?
  /// ロゴ画像
  logos                    logos[]
  /// Signed Originator Profile 発行履歴
  issuedOps                ops[]
  /// Signed Document Profile 発行履歴
  issuedDps                dps[]
  /// Signed Originator Profile 公開履歴
  publications             publications[]
  /// 公開鍵
  keys                     keys[]
  /// ウェブページ
  websites                 websites[]
  /// 管理者権限
  admins                   admins?
  /// 資格情報
  credentials              credentials[]
  /// 資格情報の発行履歴
  issuedCredentials        credentials[]               @relation("issuedCredentials")
  /// 資格情報の検証履歴
  verifiedCredentials      credentials[]               @relation("verifiedCredentials")
  /// ユーザーアカウント
  userAccounts             userAccounts?
  /// 申請
  requests                 requests[]
  /// 申請履歴
  requestLogs              requestLogs[]
  /// 申請の審査履歴
  reviewedRequests         requests[]                  @relation("certifierReviewedRequests")
  /// ログ内にある申請の審査履歴
  reviewedRequestLogs      requestLogs[]               @relation("certifierReviewedRequestLogs")
}

/// 会員種別
model roles {
  /// "group": 組織、"certifier": 認証機関
  value    String     @id
  /// 会員
  accounts accounts[]
}

/// 事業種目
model businessCategories {
  /// https://imi.go.jp/ns/core/Core242.html#ic:事業種目
  value    String                      @id
  /// 会員
  accounts accountBusinessCategories[]
}

/// 会員・事業種目リレーション
model accountBusinessCategories {
  /// 会員
  account               accounts           @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId             String             @db.Uuid
  /// 事業種目
  businessCategory      businessCategories @relation(fields: [businessCategoryValue], references: [value])
  businessCategoryValue String

  @@id([accountId, businessCategoryValue])
}

/// ロゴ画像
model logos {
  /// ロゴ画像 URL
  url       String   @id
  /// 主なロゴ画像か否か (true: 主なロゴ画像、それ以外: ロゴ画像の候補)
  isMain    Boolean  @default(false)
  /// 会員
  account   accounts @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId String   @db.Uuid
}

/// 公開
model publications {
  /// Signed Originator Profile
  op          ops      @relation(fields: [opId], references: [id], onDelete: Cascade)
  opId        String   @id @db.Uuid
  /// 会員
  account     accounts @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId   String   @db.Uuid
  /// 公開日
  publishedAt DateTime @default(now())
}

/// 公開鍵
model keys {
  id        Int      @id @default(autoincrement())
  /// 会員
  account   accounts @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId String   @db.Uuid
  /// JWK
  jwk       Json
}

/// ウェブページ
model websites {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// ウェブページ URL
  url             String
  /// 会員
  account         accounts            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId       String              @db.Uuid
  /// タイトル
  title           String?
  /// 画像URL
  image           String?
  /// 説明
  description     String?
  /// https://schema.org/author
  author          String?
  /// 情報カテゴリー (https://iabtechlab.com/wp-content/uploads/2022/04/OpenRTB-2-6_FINAL.pdf)
  categories      websiteCategories[]
  /// https://schema.org/editor
  editor          String?
  /// https://schema.org/datePublished
  datePublished   String?
  /// https://schema.org/dateModified
  dateModified    String?
  /// 対象の要素の場所 (CSS セレクター)
  location        String?
  /// 対象のテキストの形式
  bodyFormat      bodyFormats         @relation(fields: [bodyFormatValue], references: [value])
  bodyFormatValue String
  /// 対象のテキストへの署名 (Detached JSON Web Signature)
  proofJws        String
  /// Signed Document Profile
  dps             dps[]
}

/// 情報カテゴリー
model categories {
  /// 情報カテゴリー (使用タクソノミーにおけるCodeまたはUnique ID)
  cat      String
  /// 情報カテゴリー名(使用タクソノミーにおけるCategoryまたはName)
  name     String
  /// 使用タクソノミー (https://github.com/InteractiveAdvertisingBureau/AdCOM/blob/master/AdCOM%20v1.0%20FINAL.md#list_categorytaxonomies)
  cattax   Int                 @default(1)
  /// ウェブページ
  websites websiteCategories[]

  @@id([cat, cattax])
}

/// ウェブページ・情報カテゴリーリレーション
model websiteCategories {
  /// ウェブページ
  website        websites   @relation(fields: [websiteId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  websiteId      String     @db.Uuid
  /// 情報カテゴリー
  category       categories @relation(fields: [categoryCat, categoryCattax], references: [cat, cattax])
  categoryCat    String
  categoryCattax Int

  @@id([websiteId, categoryCat, categoryCattax])
}

/// 本文の形式
model bodyFormats {
  /// "visibleText" "text" "html"
  value    String     @id
  /// ウェブページ
  websites websites[]
}

/// 管理者
model admins {
  /// 管理者
  admin    accounts @relation(fields: [adminId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  adminId  String   @id @db.Uuid
  /// パスワード
  password String
}

/// 資格情報
model credentials {
  id          Int      @id @default(autoincrement())
  /// 会員
  account     accounts @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId   String   @db.Uuid
  /// 認証機関
  certifier   accounts @relation("issuedCredentials", fields: [certifierId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  certifierId String   @db.Uuid
  /// 検証機関
  verifier    accounts @relation("verifiedCredentials", fields: [verifierId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  verifierId  String   @db.Uuid
  /// 資格名
  name        String
  /// 画像URL
  image       String?
  /// 発行日
  issuedAt    DateTime
  /// 期限切れ日時
  expiredAt   DateTime
}

/// ユーザーアカウント
model userAccounts {
  /// 識別子 (OpenID Connect Standard Claims における sub)
  id               String     @id
  /// メールアドレス (OpenID Connect Standard Claims)
  email            String
  /// 名前 (OpenID Connect Standard Claims)
  name             String
  /// 画像 (OpenID Connect Standard Claims)
  picture          String
  /// 会員
  account          accounts   @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId        String     @unique @db.Uuid
  /// 申請
  requests         requests[]
  /// 申請ログ
  requestLogs      requestLogs[]
  /// 申請の審査履歴
  reviewedRequests requests[] @relation("reviewedRequests")
  /// ログ内にある申請の審査履歴
  reviewedRequestLogs requestLogs[] @relation("reviewedRequestLogs")
}

/// 申請
model requests {
  id             Int                @id @default(autoincrement())
  /// 申請担当者
  author         userAccounts       @relation(fields: [authorId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  authorId       String
  /// 組織
  group          accounts           @relation(fields: [groupId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  groupId        String             @unique @db.Uuid
  /// 審査担当者
  reviewer       userAccounts?      @relation("reviewedRequests", fields: [reviewerId], references: [id])
  reviewerId     String?
  /// 認証機関
  certifier      accounts?          @relation("certifierReviewedRequests", fields: [certifierId], references: [id])
  certifierId    String?            @db.Uuid
  /// ステータス
  status         approvalFlowStatus @relation(fields: [statusValue], references: [value])
  statusValue    String             @default("pending")
  /// 申請概要
  requestSummary String?
  /// 審査概要
  reviewSummary  String?
  /// 審査コメント
  reviewComments reviewComments[]
  /// Signed Originator Profile
  op             ops?               @relation(fields: [opId], references: [id])
  opId           String?            @unique @db.Uuid
  /// 作成日
  createdAt      DateTime           @default(now())
  /// 更新日
  updatedAt      DateTime           @updatedAt
}

/// 申請ログ
model requestLogs {
  id             Int                @id @default(autoincrement())
  /// 申請担当者
  author         userAccounts?      @relation(fields: [authorId], references: [id])
  authorId       String?
  /// 組織
  group          accounts?          @relation(fields: [groupId], references: [id])
  groupId        String?            @db.Uuid
  /// 審査担当者
  reviewer       userAccounts?      @relation("reviewedRequestLogs", fields: [reviewerId], references: [id])
  reviewerId     String?
  /// 認証機関
  certifier      accounts?          @relation("certifierReviewedRequestLogs", fields: [certifierId], references: [id])
  certifierId    String?            @db.Uuid
  /// ステータス
  status         approvalFlowStatus @relation(fields: [statusValue], references: [value])
  statusValue    String             @default("pending")
  /// 申請概要
  requestSummary String?
  /// 審査概要
  reviewSummary  String?
  /// 審査コメント
  reviewComments requestLogReviewComments[]
  /// Signed Originator Profile
  op             ops?               @relation(fields: [opId], references: [id])
  opId           String?            @unique @db.Uuid
  /// 元の申請の作成日
  createdAt      DateTime
  /// 元の申請の更新日
  updatedAt      DateTime
}

/// 承認フローステータス
model approvalFlowStatus {
  /// "pending": 審査中、"approved": 承認、"rejected": 却下、"cancelled": キャンセル
  value    String     @id
  /// 申請
  requests requests[]
  /// 申請ログ
  requestLogs requestLogs[]
}

/// 申請ログ・審査コメントリレーション
model requestLogReviewComments {
  /// 申請ログ
  requestLog     requestLogs   @relation(fields: [requestLogId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  requestLogId   Int
  /// 審査コメント
  reviewComment  reviewComments @relation(fields: [reviewCommentId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  reviewCommentId Int

  @@id([requestLogId, reviewCommentId])
}

/// 審査コメント
model reviewComments {
  id               Int      @id @default(autoincrement())
  /// 申請項目名 (HTML 要素における name 属性)
  requestFieldName String
  /// コメント
  comment          String
  /// 申請
  request          requests? @relation(fields: [requestId], references: [id])
  requestId        Int?
  /// 申請ログ
  requestLogs      requestLogReviewComments[]
}
